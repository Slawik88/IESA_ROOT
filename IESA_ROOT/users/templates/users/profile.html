{% extends 'base.html' %}
{% load static %}
{% load imagekit %}

{% block title %}Profile of {{ profile_user.username }}{% endblock %}

{% block content %}
<div class="profile-page py-5">
    <div class="container container-profile">
        <div class="row justify-content-center">
            <div class="col-12 max-w-1200">
                <!-- Profile Header -->
                <div class="profile-header mb-5">
                    <div class="row g-4">
                        <!-- Avatar -->
                        <div class="col-lg-3 col-md-4 text-center mb-4 mb-md-0">
                            <div class="profile-avatar-frame position-relative d-inline-block">
                                {% if profile_user.avatar and profile_user.avatar.name != 'avatars/default.png' %}
                                    <img src="{{ profile_user.avatar.url }}" 
                                         alt="{{ profile_user.username }}" 
                                         class="profile-avatar">
                                {% else %}
                                    <div class="profile-avatar-fallback">
                                        {{ profile_user.username|slice:":1"|upper }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <h2 class="profile-name">{{ profile_user.username }}</h2>
                            <p class="profile-email mb-3">{{ profile_user.email }}</p>
                            
                            {% if user.is_authenticated and user.id == profile_user.id and profile_user.permanent_id %}
                                <!-- Own Profile -->
                                <div class="mb-3">
                                    <span class="profile-id-badge">
                                        ID: {{ profile_user.permanent_id }}
                                    </span>
                                </div>

                                <div class="mb-4">
                                    <div class="profile-qr-card">
                                        <h6 class="profile-detail-label mb-3">Your QR Code</h6>
                                        <a href="{% url 'users:profile_by_card' permanent_id=profile_user.permanent_id %}" title="Open profile by card">
                                            <img src="{% url 'users:user_qr' permanent_id=profile_user.permanent_id %}" 
                                                 alt="QR Code" class="qr-code-img">
                                        </a>
                                        <p class="mt-3 mb-0 small text-muted">Scan to view profile</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 flex-column">
                                    <a href="{% url 'users:profile_edit' %}" class="btn btn-primary">
                                        <i class="fas fa-edit me-2"></i>Edit Profile
                                    </a>
                                    <a href="{% url 'users:user_qr' permanent_id=profile_user.permanent_id %}?download=1" class="btn btn-outline-primary">
                                        <i class="fas fa-qrcode me-2"></i>Download QR
                                    </a>
                                </div>
                            {% elif user.is_authenticated and user.id != profile_user.id %}
                                <!-- Other User's Profile - Authenticated -->
                                <div class="d-flex gap-2 flex-column mb-4">
                                    <button class="btn btn-primary btn-modern follow-btn" 
                                            data-user-id="{{ profile_user.id }}"
                                            data-username="{{ profile_user.username }}"
                                            type="button">
                                        <i class="fas fa-user-plus me-2"></i>
                                        <span class="follow-text">Follow</span>
                                    </button>
                                    <button class="btn btn-outline-primary btn-modern send-message-btn" 
                                            data-user-id="{{ profile_user.id }}"
                                            data-username="{{ profile_user.username }}"
                                            type="button">
                                        <i class="fas fa-envelope me-2"></i>Send Message
                                    </button>
                                </div>
                                
                                <!-- User Stats -->
                                <div class="profile-user-stats mb-3">
                                    <div class="stat-item">
                                        <span class="stat-value">{{ profile_user.post_set.count|default:0 }}</span>
                                        <span class="stat-label">Posts</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value">{{ profile_user.comment_set.count|default:0 }}</span>
                                        <span class="stat-label">Comments</span>
                                    </div>
                                </div>
                            {% elif not user.is_authenticated %}
                                <!-- Not Authenticated -->
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <a href="{% url 'users:login' %}">Sign in</a> to follow users and send messages
                                </div>
                            {% endif %}
                        </div>

                        <!-- Profile Details -->
                        <div class="col-lg-9 col-md-8">
                            <div class="profile-info-grid mb-4">
                                <div class="info-pill pill-red">
                                    <div class="pill-icon"><i class="fas fa-user"></i></div>
                                    <div>
                                        <p class="pill-label">Full name</p>
                                        <p class="pill-value">{{ profile_user.first_name|default:"â€”" }} {{ profile_user.last_name|default:"â€”" }}</p>
                                    </div>
                                </div>
                                <div class="info-pill pill-blue">
                                    <div class="pill-icon"><i class="fas fa-birthday-cake"></i></div>
                                    <div>
                                        <p class="pill-label">Date of birth</p>
                                        <p class="pill-value">{% if profile_user.dob %}{{ profile_user.dob|date:"d M Y" }}{% else %}â€”{% endif %}</p>
                                    </div>
                                </div>
                                <div class="info-pill pill-amber">
                                    <div class="pill-icon"><i class="fas fa-phone"></i></div>
                                    <div>
                                        <p class="pill-label">Phone</p>
                                        <p class="pill-value">{{ profile_user.phone|default:"Not provided" }}</p>
                                    </div>
                                </div>
                                <div class="info-pill pill-emerald">
                                    <div class="pill-icon"><i class="fas fa-calendar"></i></div>
                                    <div>
                                        <p class="pill-label">Joined</p>
                                        <p class="pill-value">{{ profile_user.date_joined|date:"d M Y" }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Activity Level -->
                            <div class="profile-activity-card mb-5">
                                {% with level_info=profile_user.get_achievement_level %}
                                <div class="row align-items-center">
                                    <div class="col-md-6 text-center text-md-start mb-4 mb-md-0">
                                        <div class="d-flex flex-column flex-md-row align-items-center gap-4">
                                            <div>
                                                <h6 class="profile-detail-label mb-3">Activity Level</h6>
                                                {% if level_info.level == "Legend" %}
                                                    <span class="badge badge-danger badge-level">
                                                        <i class="fas fa-crown me-2"></i>Legend
                                                    </span>
                                                {% elif level_info.level == "Expert" %}
                                                    <span class="badge badge-warning badge-level">
                                                        <i class="fas fa-star me-2"></i>Expert
                                                    </span>
                                                {% elif level_info.level == "Advanced" %}
                                                    <span class="badge badge-info badge-level">
                                                        <i class="fas fa-rocket me-2"></i>Advanced
                                                    </span>
                                                {% elif level_info.level == "Intermediate" %}
                                                    <span class="badge badge-success badge-level">
                                                        <i class="fas fa-fire me-2"></i>Intermediate
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-secondary badge-level">
                                                        <i class="fas fa-leaf me-2"></i>Beginner
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <a href="{% url 'activity_levels_info' %}" class="btn btn-ghost btn-sm" title="Learn about activity levels">
                                                <i class="fas fa-question-circle"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-center text-md-end">
                                        <div class="mb-3">
                                            <span class="profile-activity-points">{{ profile_user.activity_points }}</span>
                                            <span class="profile-activity-label">Activity Points</span>
                                        </div>
                                        {% if level_info.next_level %}
                                        <div class="small">
                                            <p class="text-muted fw-semibold mb-2">Progress to {{ level_info.next_level }}:</p>
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ level_info.progress }}%;" 
                                                     aria-valuenow="{{ level_info.progress }}" aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <p class="text-muted fw-bold mt-2">{{ level_info.progress }}%</p>
                                        </div>
                                        {% else %}
                                        <div class="small text-warning fw-bold">
                                            <i class="fas fa-trophy"></i> Maximum level achieved!
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endwith %}
                            </div>

                            <!-- Social Links -->
                            {% if profile_user.github_url or profile_user.website_url or profile_user.telegram_url or profile_user.discord_url or profile_user.other_links %}
                            <div class="profile-links-card mb-5">
                                <div class="card-header-compact">
                                    <i class="fas fa-link me-2 text-primary"></i>
                                    <span>Find me</span>
                                </div>
                                <div class="link-chip-group">
                                    {% if profile_user.github_url %}
                                        <a href="{{ profile_user.github_url }}" target="_blank" class="link-chip link-github">
                                            <i class="fab fa-github"></i>
                                            <span>GitHub</span>
                                        </a>
                                    {% endif %}
                                    {% if profile_user.website_url %}
                                        <a href="{{ profile_user.website_url }}" target="_blank" class="link-chip link-website">
                                            <i class="fas fa-globe"></i>
                                            <span>Website</span>
                                        </a>
                                    {% endif %}
                                    {% if profile_user.telegram_url %}
                                        <a href="{{ profile_user.telegram_url }}" target="_blank" class="link-chip link-telegram">
                                            <i class="fab fa-telegram"></i>
                                            <span>Telegram</span>
                                        </a>
                                    {% endif %}
                                    {% if profile_user.discord_url %}
                                        <a href="{{ profile_user.discord_url }}" target="_blank" class="link-chip link-discord">
                                            <i class="fab fa-discord"></i>
                                            <span>Discord</span>
                                        </a>
                                    {% endif %}
                                </div>
                                {% if profile_user.other_links %}
                                    <div class="other-links mt-3">
                                        {% for line in profile_user.other_links.splitlines %}
                                            <a href="{{ line }}" target="_blank" class="other-link-item">{{ line }}</a>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Post Statistics (if user's own profile) -->
                {% if user.is_authenticated and user.id == profile_user.id %}
                <div class="profile-stat-grid mb-5">
                    <div class="stat-chip chip-red">
                        <div class="chip-icon"><i class="fas fa-file-alt"></i></div>
                        <div>
                            <p class="chip-label">Total posts</p>
                            <p class="chip-value">{{ user_posts|length }}</p>
                        </div>
                    </div>
                    <div class="stat-chip chip-amber">
                        <div class="chip-icon"><i class="fas fa-heart"></i></div>
                        <div>
                            <p class="chip-label">Likes received</p>
                            <p class="chip-value">{{ profile_user.total_likes_received }}</p>
                        </div>
                    </div>
                    <div class="stat-chip chip-emerald">
                        <div class="chip-icon"><i class="fas fa-comments"></i></div>
                        <div>
                            <p class="chip-label">Comments made</p>
                            <p class="chip-value">{{ profile_user.total_comments_made }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Posts Section -->
                <div class="profile-posts-card">
                    <h3 class="profile-posts-title mb-4">
                        <i class="fas fa-list me-3 text-primary"></i>Your Posts
                    </h3>

                    {% if user_posts %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for post in user_posts %}
                                    <tr>
                                        <td>
                                            <strong class="text-dark">{{ post.title|truncatewords:8 }}</strong>
                                        </td>
                                        <td>
                                            {% if post.status == 'published' %}
                                                <span class="badge badge-success"><i class="fas fa-check-circle me-1"></i>Published</span>
                                            {% elif post.status == 'pending' %}
                                                <span class="badge badge-warning"><i class="fas fa-clock me-1"></i>Pending</span>
                                            {% elif post.status == 'rejected' %}
                                                <span class="badge badge-danger"><i class="fas fa-times-circle me-1"></i>Rejected</span>
                                            {% else %}
                                                <span class="badge badge-secondary">{{ post.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-muted fw-medium">{{ post.created_at|date:"d M Y" }}</span>
                                        </td>
                                        <td>
                                            {% if post.status == 'published' %}
                                                <a href="{% url 'blog:post_detail' post.pk %}" class="btn btn-primary btn-sm" title="View">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>You have no posts yet. <a href="{% url 'blog:post_create' %}" class="fw-bold text-info">Create your first post</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Interactions Initialization -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Force re-initialization of profile interactions
    if (window.ProfileInteractions) {
        console.log('ðŸ”„ Re-initializing ProfileInteractions on profile page...');
        window.ProfileInteractions.init();
    }
});

// Also try immediately (in case DOMContentLoaded already fired)
if (document.readyState === 'interactive' || document.readyState === 'complete') {
    if (window.ProfileInteractions) {
        console.log('ðŸ”„ Profile page ready - initializing ProfileInteractions...');
        window.ProfileInteractions.init();
    }
}
</script>
{% endblock %}