{% extends "base.html" %}

{% block title %}{{ user_obj.get_full_name|default:user_obj.username }} — Profile | IESA{% endblock %}

{% block content %}
<div class="container-limited">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card card-modern p-4">
        <div class="d-flex gap-3 align-items-center">
          {% if user_obj.avatar and user_obj.avatar.name != 'avatars/default.png' %}
            <span class="avatar avatar-lg"><img src="{{ user_obj.avatar.url }}" alt="{{ user_obj.username }} Avatar"></span>
          {% else %}
            <span class="avatar avatar-lg avatar-fallback">{{ user_obj.username|slice:":1"|upper }}</span>
          {% endif %}
          <div>
            <h2 class="mb-0">{{ user_obj.get_full_name|default:user_obj.username }}</h2>
            <p class="text-muted mb-1">@{{ user_obj.username }}</p>
            {# ID виден только владельцу #}
            {% if request.user.is_authenticated and request.user.id == user_obj.id and user_obj.permanent_id %}
              <div class="small text-muted">ID: <code id="permanent-{{ user_obj.permanent_id }}">{{ user_obj.permanent_id }}</code>
                <button class="btn btn-link btn-sm p-0 ms-2 copy-id" data-copy="#permanent-{{ user_obj.permanent_id }}" title="Copy ID"><i class="far fa-copy"></i></button>
              </div>
            {% endif %}
            {% if user_obj.is_verified %}<span class="badge bg-success">Verified</span>{% endif %}
            {% if user_obj.card_active %}<span class="badge bg-info">Card active</span>{% endif %}
          </div>
        </div>
        <hr>
        <p><strong>About</strong></p>
        <p>{{ user_obj.first_name }} {{ user_obj.last_name }}</p>
        <p class="small text-muted">Member since {{ user_obj.date_joined|date:"d M Y" }}</p>
        
        <!-- User Statistics -->
        <div class="mt-3">
          <h6 class="section-title mb-3" style="display: block;">ACTIVITY STATISTICS</h6>
          <div class="row text-center">
            <div class="col-4">
              <div class="card card-modern bg-light border-0">
                <div class="card-body py-2">
                  <h5 class="mb-0 text-primary">{{ user_obj.total_posts }}</h5>
                  <small class="text-muted">Posts</small>
                </div>
              </div>
            </div>
            <div class="col-4">
              <div class="card card-modern bg-light border-0">
                <div class="card-body py-2">
                  <h5 class="mb-0 text-danger">{{ user_obj.total_likes_received }}</h5>
                  <small class="text-muted">Likes</small>
                </div>
              </div>
            </div>
            <div class="col-4">
              <div class="card card-modern bg-light border-0">
                <div class="card-body py-2">
                  <h5 class="mb-0 text-success">{{ user_obj.total_comments_made }}</h5>
                  <small class="text-muted">Comments</small>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-2 text-center">
            {% with level_info=user_obj.get_achievement_level %}
            {% if level_info.level == "Legend" %}
              <span class="badge bg-danger"><i class="fas fa-crown me-1"></i>{{ level_info.level }}</span>
            {% elif level_info.level == "Expert" %}
              <span class="badge bg-warning"><i class="fas fa-star me-1"></i>{{ level_info.level }}</span>
            {% elif level_info.level == "Advanced" %}
              <span class="badge bg-info"><i class="fas fa-rocket me-1"></i>{{ level_info.level }}</span>
            {% elif level_info.level == "Intermediate" %}
              <span class="badge bg-success"><i class="fas fa-fire me-1"></i>{{ level_info.level }}</span>
            {% else %}
              <span class="badge bg-secondary"><i class="fas fa-leaf me-1"></i>{{ level_info.level }}</span>
            {% endif %}
            {% endwith %}
          </div>
        </div>
        
        {% if request.user.is_staff %}
          <div class="mt-2">
            <a href="/admin/users/user/{{ user_obj.pk }}/change/" class="btn btn-sm btn-outline-secondary">Open in admin panel</a>
          </div>
        {% endif %}

        <hr>
        {# QR код виден только владельцу профиля #}
        {% if request.user.is_authenticated and request.user.id == user_obj.id and user_obj.permanent_id %}
          <div class="text-center mb-3">
            <p class="text-muted"><strong>Ваш QR код</strong></p>
            <a href="{% url 'profile_by_card' permanent_id=user_obj.permanent_id %}" title="Open profile by card">
              <img src="{% url 'user_qr' permanent_id=user_obj.permanent_id %}" alt="QR for {{ user_obj.username }}" style="width:140px;height:140px;object-fit:contain;border:1px solid #e9e9e9;padding:8px;background:white;border-radius:8px;" />
            </a>
            <div class="d-flex justify-content-center gap-2 mt-2">
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'user_qr' permanent_id=user_obj.permanent_id %}?download=1">Download QR</a>
              <div class="small text-muted mt-2">Scan to open your profile</div>
            </div>
          </div>
          <hr>
        {% endif %}
        
        <!-- Social links -->
        {% if user_obj.github_url or user_obj.website_url or user_obj.telegram_url or user_obj.discord_url or user_obj.other_links %}
          <div class="mb-3">
            <h6>Links</h6>
            <div class="d-flex gap-2 flex-wrap">
              {% if user_obj.github_url %}<a class="btn btn-outline-dark btn-sm" href="{{ user_obj.github_url }}" target="_blank"><i class="fab fa-github me-1"></i>GitHub</a>{% endif %}
              {% if user_obj.website_url %}<a class="btn btn-outline-primary btn-sm" href="{{ user_obj.website_url }}" target="_blank"><i class="fas fa-link me-1"></i>Website</a>{% endif %}
              {% if user_obj.telegram_url %}<a class="btn btn-outline-info btn-sm" href="{{ user_obj.telegram_url }}" target="_blank"><i class="fab fa-telegram me-1"></i>Telegram</a>{% endif %}
              {% if user_obj.discord_url %}<a class="btn btn-outline-secondary btn-sm" href="{{ user_obj.discord_url }}" target="_blank"><i class="fab fa-discord me-1"></i>Discord</a>{% endif %}
            </div>
            {% if other_links_list %}
              <div class="mt-2 small text-muted">Other: {% for line in other_links_list %}<a href="{{ line }}" target="_blank">{{ line }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</div>
            {% endif %}
          </div>
          <hr>
        {% endif %}

        <h5>Published posts</h5>
        <div class="list-group">
          {% for p in user_posts %}
            <a href="{{ p.get_absolute_url }}" class="list-group-item list-group-item-action">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ p.title }}</h6>
                <small class="text-muted">{{ p.created_at|date:"d M Y" }}</small>
              </div>
              <p class="mb-1 small text-muted">{{ p.text|truncatewords:20|striptags }}</p>
            </a>
          {% empty %}
            <div class="list-group-item">No published posts yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
