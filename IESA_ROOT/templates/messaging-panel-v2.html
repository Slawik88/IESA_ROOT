<!-- 
    Messaging Panel v2.0 - Main messaging interface
    Features:
    - Conversation list with search
    - Real-time message updates
    - Clean error handling
    - No 403 errors
    - Integrated with new modal system
-->

<!-- Messaging Panel Overlay -->
<div id="messaging-overlay" class="messaging-overlay"></div>

<!-- Messaging Panel -->
<div id="messaging-panel" class="messaging-panel">
    <div class="messaging-panel-header">
        <h5 class="mb-0">
            <i class="fas fa-envelope me-2"></i>Messages
        </h5>
        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-primary" id="newChatBtnV2" title="Start new chat" data-action="new-chat">
                <i class="bi bi-plus-circle"></i>
            </button>
            <button class="messaging-close-btn" id="closeMessaging" aria-label="Close messages">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- Search Conversations -->
    <div class="p-3 border-bottom">
        <input 
            type="text" 
            class="form-control form-control-sm" 
            id="conversationSearch"
            placeholder="Search conversations..."
            autocomplete="off"
        >
    </div>
    
    <!-- Conversations List -->
    <div class="messaging-panel-body">
        <div id="conversationsList" class="conversations-list">
            <!-- Will be populated by JS -->
        </div>
        <div id="messagingEmptyState" class="messaging-empty-state d-none">
            <i class="fas fa-inbox fa-3x mb-3 text-muted" style="opacity: 0.5;"></i>
            <p class="fw-semibold mb-2">No conversations yet</p>
            <p class="small text-muted mb-3">Start a chat by clicking the + button above</p>
        </div>
        <div id="messagingLoadingState" class="messaging-loading-state text-center py-4 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Include Modal System -->
{% include "messaging-modal-v2.html" %}

<!-- Messaging Panel Controller Script -->
<script>
/**
 * Messaging Panel Controller v2.0
 * Main panel for displaying conversations list
 */
class MessagingPanelController {
    constructor() {
        this.apiClient = null;
        this.modalController = null;
        this.conversations = [];
        this.currentConversation = null;
        this.refreshInterval = null;
        
        console.log('ðŸŽ¯ MessagingPanelController initialized');
    }

    /**
     * Initialize the panel
     */
    async init(apiClient) {
        this.apiClient = apiClient;
        
        // Initialize modal controller
        this.modalController = new MessagingModalController();
        await this.modalController.init(apiClient);
        
        // Setup panel handlers
        this.setupPanelHandlers();
        this.setupModalButton();
        this.loadConversations();
        
        // Setup auto-refresh
        this.startAutoRefresh();
        
        console.log('âœ… MessagingPanelController ready');
    }

    /**
     * Setup panel event handlers
     */
    setupPanelHandlers() {
        const messagingBtn = document.getElementById('messagingToggle');
        const messagingPanel = document.getElementById('messaging-panel');
        const messagingOverlay = document.getElementById('messaging-overlay');
        const closeBtn = document.getElementById('closeMessaging');
        
        if (!messagingBtn || !messagingPanel) return;
        
        // Open/close panel
        messagingBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (messagingPanel.classList.contains('open')) {
                this.closePanel();
            } else {
                this.openPanel();
            }
        });
        
        if (closeBtn) {
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.closePanel();
            });
        }
        
        if (messagingOverlay) {
            messagingOverlay.addEventListener('click', () => {
                this.closePanel();
            });
        }
        
        // Search conversations
        document.getElementById('conversationSearch').addEventListener('input', (e) => {
            this.filterConversations(e.target.value);
        });
        
        // Close on outside click
        document.addEventListener('click', (e) => {
            if (messagingPanel.classList.contains('open') && 
                !messagingPanel.contains(e.target) && 
                !messagingBtn.contains(e.target)) {
                this.closePanel();
            }
        });
        
        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && messagingPanel.classList.contains('open')) {
                this.closePanel();
            }
        });
    }

    /**
     * Setup new chat button
     */
    setupModalButton() {
        const btn = document.getElementById('newChatBtnV2');
        if (!btn) return;
        
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.modalController.showChatModal();
        });
    }

    /**
     * Open panel
     */
    openPanel() {
        const messagingBtn = document.getElementById('messagingToggle');
        const messagingPanel = document.getElementById('messaging-panel');
        const messagingOverlay = document.getElementById('messaging-overlay');
        
        messagingPanel.classList.add('open');
        messagingBtn.classList.add('active');
        if (messagingOverlay) messagingOverlay.classList.add('open');
        document.body.style.overflow = 'hidden';
        
        this.loadConversations();
    }

    /**
     * Close panel
     */
    closePanel() {
        const messagingBtn = document.getElementById('messagingToggle');
        const messagingPanel = document.getElementById('messaging-panel');
        const messagingOverlay = document.getElementById('messaging-overlay');
        
        messagingPanel.classList.remove('open');
        messagingBtn.classList.remove('active');
        if (messagingOverlay) messagingOverlay.classList.remove('open');
        document.body.style.overflow = '';
    }

    /**
     * Load conversations
     */
    async loadConversations() {
        try {
            const list = document.getElementById('conversationsList');
            const empty = document.getElementById('messagingEmptyState');
            const loading = document.getElementById('messagingLoadingState');
            
            loading.classList.remove('d-none');
            list.innerHTML = '';
            empty.classList.add('d-none');
            
            const data = await this.apiClient.getConversations(20, 0);
            this.conversations = data.conversations;
            
            loading.classList.add('d-none');
            
            if (this.conversations.length === 0) {
                empty.classList.remove('d-none');
                return;
            }
            
            this.renderConversations(this.conversations);
            
        } catch (error) {
            console.error('Error loading conversations:', error);
            const list = document.getElementById('conversationsList');
            const loading = document.getElementById('messagingLoadingState');
            loading.classList.add('d-none');
            list.innerHTML = `
                <div class="alert alert-danger m-3">
                    <strong>Error loading conversations</strong><br>
                    ${error.message || 'Please try again'}
                </div>
            `;
        }
    }

    /**
     * Render conversations
     */
    renderConversations(conversations) {
        const list = document.getElementById('conversationsList');
        
        if (conversations.length === 0) {
            list.innerHTML = '';
            document.getElementById('messagingEmptyState').classList.remove('d-none');
            return;
        }
        
        const html = conversations.map(conv => {
            const title = conv.is_group ? 
                conv.group_name : 
                (conv.other_participant?.name || 'Unknown');
            
            const lastMsg = conv.last_message?.text || 'No messages yet';
            const truncatedMsg = lastMsg.length > 50 ? lastMsg.substring(0, 50) + '...' : lastMsg;
            
            return `
                <div class="conversation-item p-3 border-bottom" data-conversation-id="${conv.id}" style="cursor: pointer; transition: background-color 0.2s;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${title}</h6>
                            <small class="text-muted d-block">${truncatedMsg}</small>
                        </div>
                        ${conv.unread_count > 0 ? `<span class="badge bg-primary">${conv.unread_count}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        list.innerHTML = html;
        
        // Add click handlers
        list.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', () => {
                const convId = item.dataset.conversationId;
                this.selectConversation(parseInt(convId));
            });
            item.addEventListener('mouseover', () => {
                item.style.backgroundColor = '#f8f9fa';
            });
            item.addEventListener('mouseout', () => {
                item.style.backgroundColor = 'transparent';
            });
        });
    }

    /**
     * Select conversation
     */
    selectConversation(conversationId) {
        this.currentConversation = conversationId;
        this.apiClient.emit('conversation-selected', {
            conversation_id: conversationId
        });
    }

    /**
     * Filter conversations by search
     */
    filterConversations(query) {
        if (!query.trim()) {
            this.renderConversations(this.conversations);
            return;
        }
        
        const filtered = this.conversations.filter(conv => {
            const title = conv.is_group ? conv.group_name : conv.other_participant?.name;
            return title && title.toLowerCase().includes(query.toLowerCase());
        });
        
        this.renderConversations(filtered);
    }

    /**
     * Start auto-refresh
     */
    startAutoRefresh() {
        this.refreshInterval = setInterval(() => {
            const panel = document.getElementById('messaging-panel');
            if (panel && panel.classList.contains('open')) {
                this.loadConversations();
            }
        }, 10000); // Refresh every 10 seconds
    }

    /**
     * Stop auto-refresh
     */
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
    }
}

// Initialize when ready
document.addEventListener('DOMContentLoaded', function() {
    // Wait for MessagingAPIClient to be available
    const checkAndInit = setInterval(() => {
        if (window.MessagingAPIClient && document.querySelector('meta[name="csrf-token"]')) {
            clearInterval(checkAndInit);
            
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const apiClient = new MessagingAPIClient(csrfToken);
            const panelController = new MessagingPanelController();
            
            panelController.init(apiClient);
        }
    }, 100);
});

console.log('âœ“ Messaging Panel v2.0 loaded');
</script>
