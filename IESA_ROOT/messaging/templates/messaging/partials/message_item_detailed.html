{% load static %}

<div class="message-item {% if message.sender == user %}own{% else %}other{% endif %} {% if message.is_pinned %}message-pinned{% endif %}" 
     data-message-id="{{ message.pk }}" style="position: relative;">
    
    <div class="message-content">
        <!-- Pinned Badge -->
        {% if message.is_pinned %}
        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; font-size: 12px;">
            <i class="bi bi-pin-fill"></i>
            <span>Закреплено</span>
        </div>
        {% endif %}

        <!-- Reply To -->
        {% if message.reply_to %}
        <div class="message-reply-to">
            <i class="bi bi-reply"></i>
            <span>{{ message.reply_to.text|truncatewords:8 }}</span>
        </div>
        {% endif %}

        <!-- Message Text -->
        <div>{{ message.text }}</div>

        <!-- File Attachment -->
        {% if message.file %}
        <a href="{{ message.file.url }}" target="_blank" class="message-file">
            <i class="bi bi-file-earmark-arrow-down"></i>
            <div>
                <div class="message-file-name">{{ message.file.name|truncatechars:30 }}</div>
                <div class="message-file-size">{{ message.file.size|filesizeformat }}</div>
            </div>
        </a>
        {% endif %}

        <!-- Message Time & Read Status -->
        <div class="message-time">
            <span>{{ message.created_at|date:"H:i" }}</span>
            
            {% if message.edited_at %}
            <span title="Изменено {{ message.edited_at }}">
                <i class="bi bi-pencil"></i>
            </span>
            {% endif %}
            
            {% if message.sender == user and not conversation.is_group %}
                {% if message.read_by_count > 1 %}
                    <i class="bi bi-check2-all"></i>
                {% else %}
                    <i class="bi bi-check2"></i>
                {% endif %}
            {% elif message.sender == user and conversation.is_group %}
                {% with readers_excl=message.read_by_count|add:-1 %}
                    {% with recipients_total=participants_count|add:-1 %}
                        <span title="Прочитали: {{ readers_excl }}/{{ recipients_total }}">
                            {% if readers_excl >= recipients_total %}
                                <i class="bi bi-check2-all"></i>
                            {% else %}
                                <i class="bi bi-check2"></i>
                            {% endif %}
                        </span>
                    {% endwith %}
                {% endwith %}
            {% endif %}
        </div>
    </div>

    <!-- Message Actions (Pin, Edit, Delete) - No HTMX, using fetch API instead -->
    <div class="message-actions">
        <button class="btn" title="Закрепить" onclick="pinMessage({{ message.pk }})">
            <i class="bi bi-pin"></i>
        </button>
        {% if message.sender == user %}
        <button class="btn" title="Редактировать" onclick="editMessage({{ message.pk }})">
            <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-danger" title="Удалить" onclick="deleteMessage({{ message.pk }})">
            <i class="bi bi-trash"></i>
        </button>
        {% endif %}
    </div>
</div>
