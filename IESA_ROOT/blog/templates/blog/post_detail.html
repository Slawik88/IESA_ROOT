{% extends "base.html" %}

{% block title %}{{ post.title }} | IESA{% endblock %}

{% block meta_description %}{{ post.text|striptags|truncatewords:30 }}{% endblock %}
{% block meta_keywords %}{{ post.title }}, IESA, –±–ª–æ–≥, –ø–æ—Å—Ç—ã{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.text|striptags|truncatewords:30 }}{% endblock %}
{% block og_image %}{% if post.preview_image %}{{ request.scheme }}://{{ request.get_host }}{{ post.preview_image.url }}{% else %}{% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'img/og-default.jpg' %}{% endif %}{% endblock %}

{% block twitter_card %}summary_large_image{% endblock %}
{% block twitter_title %}{{ post.title }}{% endblock %}
{% block twitter_description %}{{ post.text|striptags|truncatewords:30 }}{% endblock %}
{% block twitter_image %}{% if post.preview_image %}{{ request.scheme }}://{{ request.get_host }}{{ post.preview_image.url }}{% else %}{% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'img/og-default.jpg' %}{% endif %}{% endblock %}

{% block content %}
<div class="container-limited">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Post Content -->
            <article class="card p-4 p-md-5 mb-4">
                <!-- –°—Ç–∞—Ç—É—Å –±–µ–π–¥–∂ -->
                <div class="mb-3">
                    {% if post.status == 'published' %}
                        <span class="badge badge-success">{{ post.get_status_display }}</span>
                    {% elif post.status == 'pending' %}
                        <span class="badge badge-warning">{{ post.get_status_display }}</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ post.get_status_display }}</span>
                    {% endif %}
                </div>
                
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <h1 class="fw-bold mb-4" style="color: var(--color-gray-900); line-height: 1.3;">{{ post.title }}</h1>
                
                <!-- –ú–µ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="d-flex align-items-center flex-wrap gap-3 mb-4 pb-3" style="border-bottom: 1px solid var(--color-gray-200);">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle me-2" style="color: var(--color-gray-400);"></i>
                        <span class="text-muted">
                            {% if post.author.username %}
                                <a href="{% url 'profile_public_username' username=post.author.username %}" class="text-decoration-none fw-semibold" style="color: var(--color-primary);">
                                    {{ post.author.username }}
                                </a>
                            {% else %}
                                <span class="text-muted">Anonymous</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="d-flex align-items-center text-muted">
                        <i class="far fa-calendar me-2" style="color: var(--color-gray-400);"></i>
                        {{ post.created_at|date:"d M Y" }}
                    </div>
                    <div class="d-flex align-items-center text-muted">
                        <i class="far fa-eye me-2" style="color: var(--color-gray-400);"></i>
                        {{ post.views_count }} views
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
                    <!-- HTMX Like Button -->
                    <div id="like-button-container" 
                         hx-get="{% url 'like_post' pk=post.pk %}" 
                         hx-trigger="load, like-event from:body" 
                         hx-swap="outerHTML">
                    </div>
                    <!-- HTMX Subscribe Button -->
                    {% if user.is_authenticated and user != post.author %}
                    <div id="subscribe-button-container" 
                         hx-get="{% url 'toggle_subscription' author_pk=post.author.pk %}" 
                         hx-trigger="load" 
                         hx-swap="outerHTML">
                    </div>
                    {% endif %}
                </div>
                
                <!-- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                {% if post.preview_image %}
                    <img src="{{ post.preview_image.url }}" class="img-fluid mb-4" alt="{{ post.title }}" style="max-height: 500px; width: 100%; object-fit: cover; border-radius: var(--radius-lg);" loading="lazy">
                {% endif %}

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å—Ç–∞ -->
                <div class="post-content" style="font-size: 1.0625rem; line-height: 1.75; color: var(--color-gray-700);">
                    {{ post.text|safe }}
                </div>
            </article>

            <!-- Comments Section -->
            <section id="comments" class="mb-5">
                <h3 class="fw-bold mb-4">Comments ({{ post.comments.count }})</h3>
                
                <!-- Comment Form (Only for authenticated users) -->
                {% if user.is_authenticated %}
                    <div class="card card-modern p-4 mb-4">
                        <h5 class="mb-3">Leave a comment</h5>
                        <form action="{% url 'comment_create' pk=post.pk %}"
                            hx-post="{% url 'comment_create' pk=post.pk %}"
                              hx-target="#comments-container"
                              hx-swap="innerHTML"
                                 hx-on::after-swap="document.querySelector('textarea[name=text]').value = ''"
                              method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                    <textarea name="text" class="form-control" id="comment-textarea" rows="3" placeholder="Your comment..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-modern">Send</button>
                        </form>
                    </div>
                {% else %}
                    <div class="alert alert-warning card-modern mb-4">
                        To comment, please <a href="{% url 'login' %}?next={{ request.path }}">sign in</a> or <a href="{% url 'register' %}">register</a>.
                    </div>
                {% endif %}

                <!-- Comments List (loaded via HTMX) -->
                <div id="comments-container" 
                     hx-get="{% url 'comment_list' pk=post.pk %}"
                     hx-trigger="load">
                    <!-- Loaded by HTMX -->
                </div>
            </section>

            <!-- Recommended Posts Section -->
            {% if recommended_posts %}
            <section class="mb-5">
                <h3 class="fw-bold mb-4">üìö Recommended Posts</h3>
                <div class="row g-3">
                    {% for post_rec in recommended_posts %}
                    <div class="col-md-6">
                        <a href="{% url 'post_detail' post_rec.pk %}" class="text-decoration-none" style="color: inherit;">
                            <div class="card card-modern h-100" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                {% if post_rec.preview_image %}
                                    <img src="{{ post_rec.preview_image.url }}" class="card-img-top" alt="{{ post_rec.title }}" style="height:150px;object-fit:cover;" loading="lazy">
                                {% else %}
                                    <div class="card-img-top" style="height:150px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;">
                                        <i class="fas fa-image fa-3x"></i>
                                    </div>
                                {% endif %}
                                <div class="card-body">
                                    <h6 class="card-title fw-bold text-truncate text-dark">{{ post_rec.title }}</h6>
                                    <p class="card-text small text-muted mb-2">
                                        <i class="fas fa-user-circle me-1"></i> {{ post_rec.author.username }}
                                        <br>
                                        <i class="fas fa-calendar-alt me-1"></i> {{ post_rec.created_at|date:"d M Y" }}
                                    </p>
                                    <p class="card-text small text-muted" style="line-height:1.4;">
                                        {{ post_rec.text|truncatewords:15|striptags }}
                                    </p>
                                </div>
                                <div class="card-footer bg-light d-flex justify-content-between align-items-center text-muted small">
                                    <span><i class="fas fa-heart me-1"></i> {{ post_rec.likes.count }}</span>
                                    <span><i class="fas fa-comment me-1"></i> {{ post_rec.comments.count }}</span>
                                    <span><i class="fas fa-eye me-1"></i> {{ post_rec.views_count }}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}